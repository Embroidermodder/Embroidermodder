name: build

on: [push]

jobs:
  build_windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Install Qt
      run: |
        python -m pip install -U pip --upgrade pip
        pip install aqtinstall
        aqt install-qt windows desktop 6.2.0 win64_msvc2019_64

    - name: build
      run: |
        git clone https://github.com/embroidermodder/embroidermodder
        cd embroidermodder
        mkdir build
        cd build
        cmake -G "MinGW Makefiles" ..
        cmake --build .
        windeployqt embroidermodder2.exe
        cpack -G WIX
        cd ../..
        
    - name: archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Windows Installer
        path: embroidermodder/embroidermodder_*

  build_macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Install Qt
      run: |
        brew install qt6 qwt

    - name: build
      run: |
        git clone https://github.com/embroidermodder/embroidermodder
        cd embroidermodder
        mkdir build
        cd build
        cmake ..
        cmake --build .
        cd ..
        
    - name: archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: MacOS Installer
        path: embroidermodder/embroidermodder_*

  build_linux:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Install Qt
      run: |
        sudo apt install qt6-base-dev libqt6*widgets* qtcreator qmake6*

    - name: build
      run: |
        git clone https://github.com/embroidermodder/embroidermodder
        cd embroidermodder
        mkdir build
        cd build
        cmake ..
        cmake --build .
        mv embroidermodder2 ../embroidermodder2
        cd ..
        rm embroidermodder2/*.cpp embroidermodder2/*.h
        tar cf embroidermodder_2.0.0-alpha_linux.tar embroidermodder2
        
    - name: archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: GNU/Linux Installer
        path: embroidermodder/embroidermodder_*

